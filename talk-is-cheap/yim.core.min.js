!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.YIM={})}(this,function(t){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])};function s(t,n){function i(){this.constructor=t}r(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}var n=i;function i(){}i.mixin=function(t){var n=t.prototype||t;n.isWildEmitter=!0,n.on=function(t,n,i){this.callbacks=this.callbacks||{};var r=3===arguments.length,e=r?n:void 0,o=r?i:n;return o.t=e,(this.callbacks[t]=this.callbacks[t]||[]).push(o),this},n.once=function(n,t,i){var r=this,e=3===arguments.length,o=e?t:void 0,s=e?i:t;return this.on(n,o,function t(){r.off(n,t),s.apply(this,arguments)}),this},n.releaseGroup=function(t){var n,i,r,e;for(n in this.callbacks=this.callbacks||{},this.callbacks)for(i=0,r=(e=this.callbacks[n]).length;i<r;i++)e[i].t===t&&(e.splice(i,1),i--,r--);return this},n.off=function(t,n){this.callbacks=this.callbacks||{};var i,r=this.callbacks[t];return r&&(1===arguments.length?delete this.callbacks[t]:(i=r.indexOf(n),r.splice(i,1),0===r.length&&delete this.callbacks[t])),this},n.emit=function(t){this.callbacks=this.callbacks||{};var n,i,r,e=[].slice.call(arguments,1),o=this.callbacks[t],s=this.getWildcardCallbacks(t);if(o)for(n=0,i=(r=o.slice()).length;n<i&&r[n];++n)r[n].apply(this,e);if(s)for(i=s.length,n=0,i=(r=s.slice()).length;n<i&&r[n];++n)r[n].apply(this,[t].concat(e));return this},n.getWildcardCallbacks=function(t){this.callbacks=this.callbacks||{};var n,i,r=[];for(n in this.callbacks)i=n.split("*"),("*"===n||2===i.length&&t.slice(0,i[0].length)===i[0])&&(r=r.concat(this.callbacks[n]));return r}},i.mixin(i);var e=function(n){function t(){var t=n.call(this)||this;return t.n={appKey:"",userId:"",token:"",timestamp:""},t}return s(t,n),t.prototype.set=function(t,n){this.n[t]=n,this.emit("change:"+t,t,n)},t.prototype.get=function(t){return this.n[t]},t}(n),o=function(r){function t(t,n){var i=r.call(this)||this;return i.i=t,i.r=n,i.e=!1,i.o=!1,i.s="",i.u="",i.h="",i.c="",i.f=6,i.r.on("message:7",function(){i.r.close(),i.o=!1,i.emit("kickoff")}),i}return s(t,r),t.prototype.login=function(t,n,i,r){var e=this;return this.o?n!==this.u?(this.logout(),new Promise(function(t){setTimeout(function(){return t()},100)}).then(function(){return e.login(t,n,i,r)})):Promise.resolve():(this.e=!0,this.i.set("appKey",t),this.i.set("userId",n),this.i.set("token",i),this.i.set("timestamp",r+""),this.s=t,this.u=n,this.h=i,this.c=r+"",this.emit("logging"),this.r.send(1,{appkey:t,userid:n+"",session:i+"",timestamp:r+"",notify:1,base:{os_type:this.f,ip:"",port:0}}).then(function(){return e.e=!1,e.o=!0,e.emit("login"),Promise.resolve()}).catch(function(t){return e.e=!1,e.o=!1,e.r.close(),e.emit("error:"+t.name,t),Promise.reject(t)}))},t.prototype.logout=function(){this.r.close(),this.o=!1,this.emit("logout")},t.prototype.isLogging=function(){return this.e},t.prototype.isLogged=function(){return this.o},t.prototype.doIfLogged=function(){var e=this;return new Promise(function(t,n){if(e.o)t();else{var i=setTimeout(function(){e.off("login",r);var t=new Error;t.name="NotLoginError",n(t)},1e4),r=function(){t(),clearTimeout(i)};e.once("login",r)}})},t.prototype.getMyUserId=function(){return this.u},t.prototype.reconnect=function(){var t=this;return this.o=!1,this.r.doWhenSigingReady().then(function(){return t.login(t.s,t.u,t.h,t.c)})},t}(n),u=function(r){function t(t,n){var i=r.call(this)||this;return i.i=t,i.r=n,i.a={},i.r.on("status:ended",function(){return i.clear()}),i}return s(t,r),t.prototype.joinRoom=function(n){var i=this;return n+="",this.a[n]||(this.a[n]=[this.i.get("userId")]),this.emit("joining:"+n,n),this.r.send(3,{roomid:n}).then(function(t){return i.emit("join:"+n,n),n}).catch(function(t){throw i.emit("join-error:"+t.name,t,n),delete i.a[n],t})},t.prototype.leaveRoom=function(n){var i=this;return n+="",this.r.send(4,{roomid:n}).then(function(){delete i.a[n],i.emit("leave:"+n,n)}).catch(function(t){throw i.emit("leave-error:"+t.name,t,n),t})},t.prototype.leaveAllRoom=function(){for(var t=[],n=0,i=Object.keys(this.a);n<i.length;n++){var r=i[n];t.push(this.leaveRoom(r))}return Promise.all(t).then(function(){})},t.prototype.clear=function(){for(var t=0,n=Object.keys(this.a);t<n.length;t++){var i=n[t];this.emit("leave:"+i,i)}this.a={}},t.prototype.doIfJoinedRoom=function(n){var i=this;return new Promise(function(t){n+="",i.inRoom(n)?t():i.once("join:"+n,function(){return t()})})},t.prototype.inRoom=function(t){return t+="",!!this.a[t]},t.prototype.getRoomIdList=function(){return Object.keys(this.a)},t.prototype.reconnect=function(){var r=this;this.r.doWhenSigingReady().then(function(){for(var t=0,n=r.getRoomIdList();t<n.length;t++){var i=n[t];r.r.send(3,{roomid:i}).then().catch(function(){})}})},t}(n),h="wss://webrtctest.youme.im",c=function(t){return t?"wss://"+t.substr(t.length-8).toLowerCase()+".h5.youme.im:443":""},f="disconnected",a="connected",d="reconnecting",v="ended",l={0:"OK",20001:"NotLoginError",20002:"InvalidParamError",20003:"InvalidLoginError",20004:"UsernameOrTokenError",20005:"LoginTimeoutError",20006:"ServiceOverloadError",20007:"MessageTooLongError"},m=function(n){function t(t){var u=n.call(this)||this;return u.i=t,u.d=1,u.f=6,u.v=null,u.l=h,u.m=f,u.y=[],u.w={},u.p={},u.g={},u.b=!1,u.k=[],u.A=[],u.S=Date.now(),u.I=0,u.O=0,u.P=!1,u._=function(t){var n=JSON.parse(t),i=n.ret,r=n.base,e=r.msgtype,o=r.seq;if(o||(o=u.g[e]),o&&u.w[o]){if(i&&"0"!==i){var s=new Error;s.name=l[i]||"Error-"+i,u.p[o](s)}else u.w[o](n);delete u.w[o],delete u.p[o]}u.emit("message:"+e,n)},u}return s(t,n),t.prototype.init=function(t){return t||(t=c(this.i.get("appKey"))),t&&(this.l=t,this.thirdSDK=null,this.x(),this.j("connecting")),this},t.prototype.send=function(i,t){var r=this;if((this.m===f||this.m===v)&&(this.init(),this.m===f||this.m===v)){var n=new Error;return n.name="NotLoginError",Promise.reject(n)}return this.S++,t.base=t.base||{},t.base=Object.assign(t.base,{msgtype:i,seq:this.S+"",version:this.d,os_type:this.f}),this.y.push(t),this.C(),this.I&&clearTimeout(this.I),this.I=setTimeout(function(){return r.T()},2e4),new Promise(function(t,n){r.w[r.S]=t,r.p[r.S]=n,r.g[i]=r.S})},t.prototype.getStatus=function(){return this.m},t.prototype.close=function(){this.j(v),this.v&&(this.v.close(),this.v=null),this.y=[],this.w={},this.S=0,this.I&&(clearTimeout(this.I),this.I=0)},t.prototype.checkNetwork=function(){var i=this;return new Promise(function(t,n){i.k.push(t),i.A.push(n),i.b||i.T()})},t.prototype.x=function(){var t=this;this.v&&this.v.close(),console.log("start connect"),"undefined"!=typeof WebSocket&&WebSocket||("undefined"!=typeof uni&&null!=uni&&uni.connectSocket&&(this.thirdSDK=uni,this.isuni=!0),"undefined"!=typeof tt&&tt&&tt.connectSocket&&(this.thirdSDK=tt,this.istt=!0),"undefined"!=typeof wx&&wx&&wx.connectSocket&&(this.thirdSDK=wx,this.iswx=!0),"undefined"!=typeof ks&&ks&&ks.connectSocket&&(this.thirdSDK=ks,this.isks=!0),"undefined"!=typeof qg&&qg&&qg.createWebSocket&&(this.thirdSDK=qg,this.isqg=!0),!this.isqg&&"undefined"!=typeof qa&&qa&&qa.connectSocket&&(this.thirdSDK=qa,this.isqa=!0),!this.thirdSDK&&"undefined"!=typeof websocketfactory&&null!=websocketfactory&&websocketfactory.create&&(this.thirdSDK=websocketfactory,this.isquickapp=!0));var n=null;this.thirdSDK&&(n=this.isqg?qg.createWebSocket:this.isquickapp?this.thirdSDK.create:this.thirdSDK.connectSocket),this.thirdSDK?(this.v=n({url:this.l,success:function(){console.log("connectSocket success")},fail:function(){console.log("connectSocket fail")},complete:function(){console.log("connectSocket complete"),setTimeout(function(){t.once("ready",function(){t.U()}),t.N()},20)}}),(this.isqg||this.isquickapp)&&setTimeout(function(){t.once("ready",function(){t.U()}),t.N()},20)):(console.log("connectSocket"),this.v=new WebSocket(this.l),setTimeout(function(){t.once("ready",function(){t.U()}),t.N()},20))},t.prototype.B=function(){var t=this;if(!this.P){if(this.P=!0,this.m!==v){if(this.m!==d){for(var n in this.p)if(this.p.hasOwnProperty(n))try{this.p[n](new Error("Socket was closed."))}catch(t){console.error("IM reconnect finished. Socket was closed.")}this.w={},this.p={},this.j(d)}this.v=null,setTimeout(function(){t.m===d&&(t.x(),t.P=!1)},2e3)}this.I&&(clearTimeout(this.I),this.I=0),this.O&&(clearInterval(this.O),this.O=0)}},t.prototype.N=function(){var n=this;console.log("socketEvent:"+this.v),this.v&&(this.thirdSDK||void 0===this.v.addEventListener?this.isks||this.isqa?(this.v.onSocketOpen(function(t){console.log("WebSocket连接已打开"),n.j(a),n.emit("ready"),n.C()}),this.v.onSocketError(function(t){console.log("WebSocket连接打开失败"),n.emit("error",t)}),this.v.onSocketClose(function(t){console.log("WebSocket连接已关闭")}),this.v.onSocketMessage(function(t){console.log("recv msg"),n._(t.data)})):this.isquickapp||this.isqg||void 0===this.v.addEventListener?(this.v.onopen=function(t){console.log("WebSocket连接已打开"),n.j(a),n.emit("ready"),n.C()},this.v.onerror=function(t){console.log("WebSocket连接打开失败"),n.emit("error",t)},this.v.onclose=function(t){console.log("WebSocket连接已关闭")},this.v.onmessage=function(t){console.log("recv msg"),n._(t.data)}):(this.v.onOpen(function(t){console.log("WebSocket连接已打开"),n.j(a),n.emit("ready"),n.C()}),this.v.onError(function(t){console.log("WebSocket连接打开失败"),n.emit("error",t)}),this.v.onClose(function(t){console.log("WebSocket连接已关闭")}),this.v.onMessage(function(t){console.log("recv msg"),n._(t.data)})):(this.v.addEventListener("open",function(){n.j(a),n.emit("ready"),n.C()}),this.v.addEventListener("error",function(t){n.B(),n.emit("error",t)}),this.v.addEventListener("close",function(){n.B()}),this.v.addEventListener("message",function(t){n._(t.data)})))},t.prototype.doWhenSigingReady=function(){var n=this;return new Promise(function(t){if(n.getStatus()===a)return t();n.once("ready",function(){t()})})},t.prototype.j=function(t){this.m!==t&&(this.m=t,this.emit("status:"+t,t))},t.prototype.C=function(){if(this.m===a&&this.v){for(var t=0,n=this.y;t<n.length;t++){var i=n[t];this.thirdSDK&&!this.isqg?this.v.send({data:JSON.stringify(i)}):this.v.send(JSON.stringify(i));var r=i.base;this.emit("send:"+r.msgtype,i)}this.y=[]}},t.prototype.U=function(){var t=this;this.O&&(clearInterval(this.O),this.O=0),this.O=setInterval(function(){t.b||t.send(0,{}).catch(function(){})},6e4),this.once("status:"+v,function(){t.O&&(clearInterval(t.O),t.O=0)}),this.once("status:"+d,function(){t.O&&(clearInterval(t.O),t.O=0)})},t.prototype.T=function(){var t=this;if(!this.b){this.b=!0;var n=setTimeout(function(){t.q(!1),t.v&&t.v.close(),t.B()},1e4);this.send(0,{}).then(function(){clearTimeout(n),t.q(!0)}).catch(function(){clearTimeout(n),t.q(!1)})}},t.prototype.q=function(t){if(t)for(var n=0,i=this.k;n<i.length;n++){var r=i[n];r&&r()}else for(var e=0,o=this.A;e<o.length;e++){var s=o[e];s&&s()}this.k=[],this.A=[],this.b=!1},t}(n),b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var y,w=(function(g){!function(){var c="input is invalid type",t="object"==typeof window,n=t?window:{};n.JS_MD5_NO_WINDOW&&(t=!1);var i=!t&&"object"==typeof self,r=!n.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;r?n=b:i&&(n=self);var e,o=!n.JS_MD5_NO_COMMON_JS&&g.exports,f=!n.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,s="0123456789abcdef".split(""),u=[128,32768,8388608,-2147483648],a=[0,8,16,24],h=["hex","array","digest","buffer","arrayBuffer","base64"],d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),v=[];if(f){var l=new ArrayBuffer(68);e=new Uint8Array(l),v=new Uint32Array(l)}!n.JS_MD5_NO_NODE_JS&&Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),!f||!n.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(t){return"object"==typeof t&&t.buffer&&t.buffer.constructor===ArrayBuffer});var m=function(n){return function(t){return new w(!0).update(t)[n]()}},y=function(n){var i=[eval][0]("require('crypto')"),r=[eval][0]("require('buffer').Buffer");return function(t){if("string"==typeof t)return i.createHash("md5").update(t,"utf8").digest("hex");if(null==t)throw c;return t.constructor===ArrayBuffer&&(t=new Uint8Array(t)),Array.isArray(t)||ArrayBuffer.isView(t)||t.constructor===r?i.createHash("md5").update(new r(t)).digest("hex"):n(t)}};function w(t){if(t)v[0]=v[16]=v[1]=v[2]=v[3]=v[4]=v[5]=v[6]=v[7]=v[8]=v[9]=v[10]=v[11]=v[12]=v[13]=v[14]=v[15]=0,this.blocks=v,this.buffer8=e;else if(f){var n=new ArrayBuffer(68);this.buffer8=new Uint8Array(n),this.blocks=new Uint32Array(n)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}w.prototype.update=function(t){if(!this.finalized){var n,i=typeof t;if("string"!==i){if("object"!==i)throw c;if(null===t)throw c;if(f&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||f&&ArrayBuffer.isView(t)))throw c;n=!0}for(var r,e,o=0,s=t.length,u=this.blocks,h=this.buffer8;o<s;){if(this.hashed&&(this.hashed=!1,u[0]=u[16],u[16]=u[1]=u[2]=u[3]=u[4]=u[5]=u[6]=u[7]=u[8]=u[9]=u[10]=u[11]=u[12]=u[13]=u[14]=u[15]=0),n)if(f)for(e=this.start;o<s&&e<64;++o)h[e++]=t[o];else for(e=this.start;o<s&&e<64;++o)u[e>>2]|=t[o]<<a[3&e++];else if(f)for(e=this.start;o<s&&e<64;++o)(r=t.charCodeAt(o))<128?h[e++]=r:(r<2048?h[e++]=192|r>>6:(r<55296||57344<=r?h[e++]=224|r>>12:(r=65536+((1023&r)<<10|1023&t.charCodeAt(++o)),h[e++]=240|r>>18,h[e++]=128|r>>12&63),h[e++]=128|r>>6&63),h[e++]=128|63&r);else for(e=this.start;o<s&&e<64;++o)(r=t.charCodeAt(o))<128?u[e>>2]|=r<<a[3&e++]:(r<2048?u[e>>2]|=(192|r>>6)<<a[3&e++]:(r<55296||57344<=r?u[e>>2]|=(224|r>>12)<<a[3&e++]:(r=65536+((1023&r)<<10|1023&t.charCodeAt(++o)),u[e>>2]|=(240|r>>18)<<a[3&e++],u[e>>2]|=(128|r>>12&63)<<a[3&e++]),u[e>>2]|=(128|r>>6&63)<<a[3&e++]),u[e>>2]|=(128|63&r)<<a[3&e++]);this.lastByteIndex=e,this.bytes+=e-this.start,64<=e?(this.start=e-64,this.hash(),this.hashed=!0):this.start=e}return 4294967295<this.bytes&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},w.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,n=this.lastByteIndex;t[n>>2]|=u[3&n],56<=n&&(this.hashed||this.hash(),t[0]=t[16],t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.bytes<<3,t[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},w.prototype.hash=function(){var t,n,i,r,e,o,s=this.blocks;this.first?n=((n=((t=((t=s[0]-680876937)<<7|t>>>25)-271733879<<0)^(i=((i=(-271733879^(r=((r=(-1732584194^2004318071&t)+s[1]-117830708)<<12|r>>>20)+t<<0)&(-271733879^t))+s[2]-1126478375)<<17|i>>>15)+r<<0)&(r^t))+s[3]-1316259209)<<22|n>>>10)+i<<0:(t=this.h0,n=this.h1,i=this.h2,n=((n+=((t=((t+=((r=this.h3)^n&(i^r))+s[0]-680876936)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+s[1]-389564586)<<12|r>>>20)+t<<0)&(t^n))+s[2]+606105819)<<17|i>>>15)+r<<0)&(r^t))+s[3]-1044525330)<<22|n>>>10)+i<<0),n=((n+=((t=((t+=(r^n&(i^r))+s[4]-176418897)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+s[5]+1200080426)<<12|r>>>20)+t<<0)&(t^n))+s[6]-1473231341)<<17|i>>>15)+r<<0)&(r^t))+s[7]-45705983)<<22|n>>>10)+i<<0,n=((n+=((t=((t+=(r^n&(i^r))+s[8]+1770035416)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+s[9]-1958414417)<<12|r>>>20)+t<<0)&(t^n))+s[10]-42063)<<17|i>>>15)+r<<0)&(r^t))+s[11]-1990404162)<<22|n>>>10)+i<<0,n=((n+=((t=((t+=(r^n&(i^r))+s[12]+1804603682)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+s[13]-40341101)<<12|r>>>20)+t<<0)&(t^n))+s[14]-1502002290)<<17|i>>>15)+r<<0)&(r^t))+s[15]+1236535329)<<22|n>>>10)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+s[1]-165796510)<<5|t>>>27)+n<<0)^n))+s[6]-1069501632)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+s[11]+643717713)<<14|i>>>18)+r<<0)^r))+s[0]-373897302)<<20|n>>>12)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+s[5]-701558691)<<5|t>>>27)+n<<0)^n))+s[10]+38016083)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+s[15]-660478335)<<14|i>>>18)+r<<0)^r))+s[4]-405537848)<<20|n>>>12)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+s[9]+568446438)<<5|t>>>27)+n<<0)^n))+s[14]-1019803690)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+s[3]-187363961)<<14|i>>>18)+r<<0)^r))+s[8]+1163531501)<<20|n>>>12)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+s[13]-1444681467)<<5|t>>>27)+n<<0)^n))+s[2]-51403784)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+s[7]+1735328473)<<14|i>>>18)+r<<0)^r))+s[12]-1926607734)<<20|n>>>12)+i<<0,n=((n+=((o=(r=((r+=((e=n^i)^(t=((t+=(e^r)+s[5]-378558)<<4|t>>>28)+n<<0))+s[8]-2022574463)<<11|r>>>21)+t<<0)^t)^(i=((i+=(o^n)+s[11]+1839030562)<<16|i>>>16)+r<<0))+s[14]-35309556)<<23|n>>>9)+i<<0,n=((n+=((o=(r=((r+=((e=n^i)^(t=((t+=(e^r)+s[1]-1530992060)<<4|t>>>28)+n<<0))+s[4]+1272893353)<<11|r>>>21)+t<<0)^t)^(i=((i+=(o^n)+s[7]-155497632)<<16|i>>>16)+r<<0))+s[10]-1094730640)<<23|n>>>9)+i<<0,n=((n+=((o=(r=((r+=((e=n^i)^(t=((t+=(e^r)+s[13]+681279174)<<4|t>>>28)+n<<0))+s[0]-358537222)<<11|r>>>21)+t<<0)^t)^(i=((i+=(o^n)+s[3]-722521979)<<16|i>>>16)+r<<0))+s[6]+76029189)<<23|n>>>9)+i<<0,n=((n+=((o=(r=((r+=((e=n^i)^(t=((t+=(e^r)+s[9]-640364487)<<4|t>>>28)+n<<0))+s[12]-421815835)<<11|r>>>21)+t<<0)^t)^(i=((i+=(o^n)+s[15]+530742520)<<16|i>>>16)+r<<0))+s[2]-995338651)<<23|n>>>9)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+s[0]-198630844)<<6|t>>>26)+n<<0)|~i))+s[7]+1126891415)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+s[14]-1416354905)<<15|i>>>17)+r<<0)|~t))+s[5]-57434055)<<21|n>>>11)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+s[12]+1700485571)<<6|t>>>26)+n<<0)|~i))+s[3]-1894986606)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+s[10]-1051523)<<15|i>>>17)+r<<0)|~t))+s[1]-2054922799)<<21|n>>>11)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+s[8]+1873313359)<<6|t>>>26)+n<<0)|~i))+s[15]-30611744)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+s[6]-1560198380)<<15|i>>>17)+r<<0)|~t))+s[13]+1309151649)<<21|n>>>11)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+s[4]-145523070)<<6|t>>>26)+n<<0)|~i))+s[11]-1120210379)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+s[2]+718787259)<<15|i>>>17)+r<<0)|~t))+s[9]-343485551)<<21|n>>>11)+i<<0,this.first?(this.h0=t+1732584193<<0,this.h1=n-271733879<<0,this.h2=i-1732584194<<0,this.h3=r+271733878<<0,this.first=!1):(this.h0=this.h0+t<<0,this.h1=this.h1+n<<0,this.h2=this.h2+i<<0,this.h3=this.h3+r<<0)},w.prototype.toString=w.prototype.hex=function(){this.finalize();var t=this.h0,n=this.h1,i=this.h2,r=this.h3;return s[t>>4&15]+s[15&t]+s[t>>12&15]+s[t>>8&15]+s[t>>20&15]+s[t>>16&15]+s[t>>28&15]+s[t>>24&15]+s[n>>4&15]+s[15&n]+s[n>>12&15]+s[n>>8&15]+s[n>>20&15]+s[n>>16&15]+s[n>>28&15]+s[n>>24&15]+s[i>>4&15]+s[15&i]+s[i>>12&15]+s[i>>8&15]+s[i>>20&15]+s[i>>16&15]+s[i>>28&15]+s[i>>24&15]+s[r>>4&15]+s[15&r]+s[r>>12&15]+s[r>>8&15]+s[r>>20&15]+s[r>>16&15]+s[r>>28&15]+s[r>>24&15]},w.prototype.array=w.prototype.digest=function(){this.finalize();var t=this.h0,n=this.h1,i=this.h2,r=this.h3;return[255&t,t>>8&255,t>>16&255,t>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255,255&i,i>>8&255,i>>16&255,i>>24&255,255&r,r>>8&255,r>>16&255,r>>24&255]},w.prototype.buffer=w.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(16),n=new Uint32Array(t);return n[0]=this.h0,n[1]=this.h1,n[2]=this.h2,n[3]=this.h3,t},w.prototype.base64=function(){for(var t,n,i,r="",e=this.array(),o=0;o<15;)t=e[o++],n=e[o++],i=e[o++],r+=d[t>>>2]+d[63&(t<<4|n>>>4)]+d[63&(n<<2|i>>>6)]+d[63&i];return t=e[o],r+=d[t>>>2]+d[t<<4&63]+"=="};var p=function(){var n=m("hex");r&&(n=y(n)),n.create=function(){return new w},n.update=function(t){return n.create().update(t)};for(var t=0;t<h.length;++t){var i=h[t];n[i]=m(i)}return n}();o?g.exports=p:n.md5=p}()}(y={exports:{}},y.exports),y.exports),p=(w.hex,w.array,w.digest,w.arrayBuffer,w.buffer,w.create),g=(w.update,w.base64,function(t){function f(){var i=null!==t&&t.apply(this,arguments)||this;return i.__isReady=!1,i.__isCanceled=!1,i.__reqUpTk=null,i.__reqWXTk=null,i.__onReadyQueue=[],i.__onCancelQueue=[],i.__onSetUpTkFn=[],i.__onSetWXTkFn=[],i.__content="",i.__extraParam="",i.typeId=0,i.__controls={initWithContent:function(t,n){return i.initWithContent(t,n).then(function(){return i.setContent(t)})},getContent:function(){return i.getContent()},getTypeId:function(){return i.getTypeId()},getType:function(){return i.getType()},onRequestUploadToken:function(t){return i.__onReqUpTk(t)},onRequestWechatToken:function(t){return i.__onReqWXTk(t)},waitForContent:function(){return i.__waitForContent()}},i}return s(f,t),f.prototype.setContent=function(t){this.__content="string"==typeof t?t:JSON.stringify(t),this.__isReady=!0;for(var n=0,i=this.__onReadyQueue;n<i.length;n++){(0,i[n])(this.__content)}this.__onReadyQueue=[]},f.prototype.setExtraParam=function(t){this.__extraParam="string"==typeof t?t:JSON.stringify(t)},f.prototype.setCanceled=function(){this.__isCanceled=!0;for(var t=0,n=this.__onCancelQueue;t<n.length;t++){var i=n[t],r=new Error("Message Canceled.");r.name="CanceledError",i(r)}this.__onCancelQueue=[]},f.prototype.uploadFile=function(h){var c=this;return new Promise(function(o,s){var e,u=new FileReader;u.onload=function(){if(!(e=u.result)){var t=new Error;return t.name="UploadFileError",s(t)}var n=p();n.update(e);var i=n.hex(),r=function(i){var r=new XMLHttpRequest;r.ontimeout=function(t){s(t)},r.onerror=function(t){s(t)},r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){var t=i.downloadUrl,n=t.indexOf(":");-1<n&&n<7&&(t=t.substr(n+1)),o(t)}};var t=i.uploadUrl,n=t.indexOf(":");for(var e in-1<n&&n<7&&(t=t.substr(n+1)),r.open("PUT",t,!0),r.timeout=6e4,i.headers)"host"!==e&&i.headers.hasOwnProperty(e)&&r.setRequestHeader(e,i.headers[e]);r.send(h)};if(c.__reqUpTk)c.__reqUpTk(h.size,i,i,h.type.split("/")[1]).then(r).catch(function(t){return s(t)});else if(f.__gControls.reqUpTk)f.__gControls.reqUpTk(h.size,i,i,h.type.split("/")[1]).then(r).catch(function(t){return s(t)});else{new Promise(function(t){c.__onSetUpTkFn.push(t)}).then(function(){c.__reqUpTk(h.size,i,i,h.type.split("/")[1]).then(r).catch(function(t){return s(t)})})}},u.readAsArrayBuffer(h)})},f.prototype.requestWechatToken=function(){var n=this;return this.__reqWXTk?this.__reqWXTk():f.__gControls.reqWXTk?f.__gControls.reqWXTk():new Promise(function(t){n.__onSetWXTkFn.push(t)}).then(function(){return n.__reqWXTk()})},f.prototype.isReady=function(){return this.__isReady},f.prototype.isCanceled=function(){return this.__isCanceled},f.prototype.onReady=function(t,n){if(this.__isReady)return t();this.__isCanceled?n&&n():this.__waitForContent().then(function(){t()}).catch(function(t){"CanceledError"===t.name&&n&&n()})},f.prototype.getContent=function(){var t;if(this.__isCanceled)throw(t=new Error("Message Canceled.")).name="CanceledError",t;if(!this.__isReady)throw(t=new Error("Content is not ready yet.")).name="ContentNotReadyError",t;return this.__content},f.prototype.getExtraParam=function(){return this.__extraParam},f.prototype.getTypeId=function(){return this.typeId},f.prototype.getType=function(){return this.typeName},f.prototype.__onReqUpTk=function(t){this.__reqUpTk=t;for(var n=0,i=this.__onSetUpTkFn;n<i.length;n++){(0,i[n])()}this.__onSetUpTkFn=[]},f.prototype.__onReqWXTk=function(t){this.__reqWXTk=t;for(var n=0,i=this.__onSetWXTkFn;n<i.length;n++){(0,i[n])()}this.__onSetWXTkFn=[]},f.prototype.__waitForContent=function(){var i=this;if(this.__isReady)return Promise.resolve(this.__content);if(this.__isCanceled){var t=new Error("Message Canceled.");return t.name="CanceledError",Promise.reject(t)}return new Promise(function(t,n){i.__onReadyQueue.push(t),i.__onCancelQueue.push(n)})},f.__gControls={},f}(n)),k=function(r){function t(t,n){var i=r.call(this)||this;return i.D="",i.J="",i.typeId=0,i.typeName="text",void 0!==t&&i.setText(t),void 0!==n&&i.setAttachParam(n),i}return s(t,r),t.prototype.setText=function(t){this.D=t.toString(),this.setContent(this.D)},t.prototype.getText=function(){return this.D},t.prototype.setAttachParam=function(t){this.J=t.toString(),this.setExtraParam(this.J)},t.prototype.getAttachParam=function(){return this.J},t.prototype.initWithContent=function(t,n){return this.D=t.toString(),void 0!==n&&(this.J=n.toString()),Promise.resolve()},t.filterDirty=function(t,n){return void 0===n&&(n="**"),this.W?t.replace(this.W,n):t},t.setDirtyWords=function(t){this.W=t?new RegExp(t.join("|"),"ig"):null},t.W=null,t}(g),A=function(r){function o(t,n){var i=r.call(this)||this;i.i=t,i.r=n,i.H={},i.M={},i.F=new Set,i.L={},i.R={},i.K="",i.z=new Date(0),i.win=window;var s=i;return i.r.on("message:9",function(t){if(t&&"object"==typeof t.args){var n=0;n=t.args.msg_for?0:parseInt(t.args.msg_id)-1,i.r.send(10,{msgid:n+""}).then(function(t){var e=t.msg_list[0];if(1==e.chattype){"atta"==e.comment.AttachParam&&(e.comment=JSON.stringify({AttachParam:"atta"}));var n=indexedDB.open("ymH5imPrivateChatDB_"+e.receiver+"_"+e.sender,1),o="private_chat";n.onupgradeneeded=function(t){t.target.result.createObjectStore(o,{keyPath:"svr_msgid"}).createIndex("myUserIdAndOtherIndex","myUserIdAndOther",{unique:!1})},n.onsuccess=function(t){s.addChatContact(e.receiver,e.sender);var n=t.target.result.transaction([o],"readwrite").objectStore(o),i={svr_msgid:e.svr_msgid,chattype:e.chattype,comment:e.comment,content:e.content,msgtype:e.msgtype,myUserIdAndOther:e.receiver+"_"+e.sender,receiver:e.receiver,sender:e.sender,sender_serial:"",serial:e.serial,timespan:e.timespan},r=n.add(i);r.onerror=function(t){console.log("接收聊天:"+e.svr_msgid+" 失败！！！")},r.onsuccess=function(t){console.log("接收聊天:"+e.svr_msgid+"数据成功！！！")}}}i.X(t)}).catch(function(){})}}),g.__gControls.reqUpTk=i.G.bind(i),g.__gControls.reqWXTk=i.Q.bind(i),i}return s(o,r),o.prototype.registerMessageType=function(t){var n=new t,i=n.__controls.getTypeId(),r=n.__controls.getType();0===i&&"text"!==r?this.R[r]=t:this.L[i]=t},o.prototype.sendToRoom=function(i,r){var e=this;return i+="",this.V(r).then(function(n){var t=o.Y(i,"group",n);return e.Z(t).then(function(t){if(void 0!==t){var n=e.$(i,"group",t.svr_msgid,r);return e.nt(n),e.emit("send:group:"+i,n),n}e.emit("send-failed:NotLoginError:group:"+i,r)}).catch(function(t){throw e.emit("send-failed:"+t.name+":group:"+i+":"+t.name,n,t),t})})},o.prototype.sendToUser=function(d,i,v){var r=this,l=this;return this.V(i).then(function(n){var a=o.Y(d,"user",n);return r.Z(a).then(function(t){if(void 0!==t){var c=r.$(d,"user",t.svr_msgid,i);if("user"==c.chatType){var n=indexedDB.open("ymH5imPrivateChatDB_"+v+"_"+d,1),f="private_chat";n.onupgradeneeded=function(t){t.target.result.createObjectStore(f,{keyPath:"svr_msgid"}).createIndex("myUserIdAndOtherIndex","myUserIdAndOther",{unique:!1})},n.onsuccess=function(t){l.addChatContact(v,d);var n=t.target.result.transaction([f],"readwrite").objectStore(f),i=a.base,r=c.message,e=c.time,o=Date.parse(e),s=o.toString().substring(0,10);o=parseInt(s),"atta"==r.__extraParam&&(r.__extraParam=JSON.stringify({AttachParam:"atta"}));var u={svr_msgid:c.serverId,chattype:1,comment:r.__extraParam,content:r.__content,msgtype:r.typeId,myUserIdAndOther:v+"_"+d,receiver:c.receiverId,sender:c.senderId,sender_serial:"",serial:i.seq,timespan:o},h=n.add(u);h.onerror=function(t){console.log("发送聊天：webDb:"+c.serverId+" 失败！！！")},h.onsuccess=function(t){console.log("发送聊天：webDb:"+c.serverId+"数据成功！！！")}}}return r.nt(c),r.emit("send:user:"+d,c),c}r.emit("send-failed:NotLoginError:group:"+d,i)}).catch(function(t){throw r.emit("send-failed:"+t.name+":user:"+d,n,t),t})})},o.prototype.requestHistoryMessage=function(t,n,i,r){var s=this;return this.r.send(11,{interlocutor:t,min_msgid:n,max_msgid:i,day_interval:r}).then(function(t){for(var n=[],i=0,r=t.msg_list;i<r.length;i++){var e=r[i],o=s.it(e);n.push(o)}return n}).catch(function(){return[]})},o.prototype.queryRoomHistoryMessageByLastMsgid=function(t,c,f,n){var a=this;return 30<c?c=30:c<0&&(c=0),this.r.send(18,{roomid:t,count:c,directon:f,last_msgid:n}).then(function(t){for(var n=[],i=t.msg_list,r=i.length,e=0,o=0,s=i;o<s.length;o++){var u=s[o],h=a.it(u);e+=1,1==f?n[r-e]=h:n.push(h)}return n.slice(0,c)}).catch(function(){return[]})},o.prototype.getHistoryContact=function(t,n){var i=[],r=localStorage.getItem("ymH5imChatContact_"+n);r&&(i=JSON.parse(r)),"function"==typeof t&&t(i)},o.prototype.deleteHistoryContact=function(t,n,i){var r=[],e=localStorage.getItem("ymH5imChatContact_"+n);(e=JSON.parse(e)).splice(e.indexOf(t),1),localStorage.setItem("ymH5imChatContact_"+n,JSON.stringify(e));var o="ymH5imPrivateChatDB_"+n+"_"+t,s=indexedDB.open(o,1),u="private_chat";s.onupgradeneeded=function(t){t.target.result.createObjectStore(u,{keyPath:"svr_msgid"}).createIndex("myUserIdAndOtherIndex","myUserIdAndOther",{unique:!1})},s.onsuccess=function(t){var n=t.target.result.transaction([u],"readwrite").objectStore(u).clear();n.onsuccess=function(t){console.log("清空"+o+"数据库成功")},n.onerror=function(t){console.log(t)}};try{"function"==typeof i&&(r.ActionStatus="OK",r.ErrorCode=0,r.ErrorInfo="",i(r))}catch(t){"function"==typeof i&&(r.ActionStatus="Fail",r.ErrorCode=30001,r.ErrorInfo=t,i(r))}},o.prototype.in_array=function(t,n){for(var i=0;i<n.length;i++){if(n[i]==t)return!0}return!1},o.prototype.addChatContact=function(t,n){var i=[],r=localStorage.getItem("ymH5imChatContact_"+t);r?(i=JSON.parse(r),this.in_array(n,i)||(i.push(n),console.log("追加私聊联系人："+n))):(i.push(n),console.log("新增私聊联系人："+n)),localStorage.setItem("ymH5imChatContact_"+t,JSON.stringify(i))},o.prototype.queryPrivateHistoryMessageByLastMsgid=function(f,a,d,v,l,m){var o=this;return l=l.toString(),this.r.send(10,{msgid:l.toString()}).then(function(t){var n=t.msg_list,u=n.length,h=o,c=0;if(0<u)for(var i=function(e){var o;e.comment=JSON.stringify(e.comment),"atta"==e.__extraParam&&(e.__extraParam=JSON.stringify({AttachParam:"atta"})),o=a!=e.receiver?e.receiver:e.sender;var t=indexedDB.open("ymH5imPrivateChatDB_"+a+"_"+o,1),s="private_chat";t.onupgradeneeded=function(t){t.target.result.createObjectStore(s,{keyPath:"svr_msgid"}).createIndex("myUserIdAndOtherIndex","myUserIdAndOther",{unique:!1})},t.onsuccess=function(t){h.addChatContact(a,o);var n=t.target.result.transaction([s],"readwrite").objectStore(s),i={svr_msgid:e.svr_msgid,chattype:e.chattype,comment:e.comment,content:e.content,msgtype:e.msgtype,myUserIdAndOther:a+"_"+f,receiver:e.receiver,sender:e.sender,sender_serial:e.sender_serial,serial:e.serial,timespan:e.timespan},r=n.add(i);r.onerror=function(t){c+=1,console.log("插入数据:"+e.svr_msgid+" 已存在！！！"),c==u&&h.getPrivateChat(f,a,d,v,l,m)},r.onsuccess=function(t){c+=1,console.log("插入数据:"+e.svr_msgid+"成功！！！"),c==u&&h.getPrivateChat(f,a,d,v,l,m)}}},r=0,e=n;r<e.length;r++){i(e[r])}else o.getPrivateChat(f,a,d,v,l,m);return[].slice(0,d)}).catch(function(){return[]})},o.prototype.getPrivateChat=function(t,n,e,o,s,u){var h=[],c=this,f=0==o?"next":"prev",i=indexedDB.open("ymH5imPrivateChatDB_"+n+"_"+t,1),a="private_chat";i.onupgradeneeded=function(t){t.target.result.createObjectStore(a,{keyPath:"svr_msgid"}).createIndex("myUserIdAndOtherIndex","myUserIdAndOther",{unique:!1})},i.onsuccess=function(t){var n,r=0,i=t.target.result.transaction([a],"readwrite").objectStore(a);0==o?n=IDBKeyRange.lowerBound(s,!0):1==o&&0<s?n=IDBKeyRange.upperBound(s,!0):1==o&&0==s&&(n=IDBKeyRange.lowerBound(s,!0)),i.openCursor(n,f).onsuccess=function(t){var n=t.target.result;if(n&&null!==n&&r<e){r++;var i=c.it(n.value);h.push(i),n.continue()}else"function"==typeof u&&u(h),console.log("遍历聊天记录结束")}}},o.prototype.clear=function(){this.H={},this.M={},this.F.clear()},o.prototype.X=function(t){for(var e=this,n=t.msg_list,i=function(t){var n=o.it(t),i=n.withPeer,r=n.chatType;o.nt(n)&&o.V(n.message).then(function(){e.emit("receive:"+r+":"+i,n)})},o=this,r=0,s=n;r<s.length;r++){i(s[r])}},o.prototype.it=function(t){var n,i=this,r=t.sender,e=t.receiver,o=t.sender===this.i.get("userId");if(t&&1==t.msgtype&&t.comment&&!t.comment.h5){var s=t.content;/^https:/i.test(s)&&(s=s.replace(/^https:/i,"")),t.content=JSON.stringify({datasize:parseInt(t.comment.FileSize),downloadurl:s,voicetime:t.comment.Time,AudioText:t.comment?t.comment.AudioText:"",comment:t.comment,recordmode:2,extra:t.comment.Param})}if(t&&2==t.msgtype&&t.comment){s=t.content;/^https:/i.test(s)&&(s=s.replace(/^https:/i,"")),t.content=JSON.stringify({filesize:parseInt(t.comment.FileSize),downloadurl:s,filetype:t.comment.FileType,filename:t.comment.FileName,comment:t.comment,extension:t.comment.Extension,extra:t.comment.Param})}switch(t.chattype){case 1:default:n="user";break;case 2:n="group"}var u,h=new Date(1e3*t.timespan),c=t.msgtype,f=t.content;if(0===c){var a=f.match(/^(.+?)!/),d=a?a[1]:null;d&&(u=this.R[d])?f=f.replace(/^(.+?)!/,""):u=this.L[0]}else u=this.L[c];if(!u){var v=new Error;throw v.name="MessageTypeMissingError",v}var l=new u,m=t&&t.comment&&t.comment.AttachParam?t.comment.AttachParam:"";'{"AttachParam":"atta"}'!=t.comment&&"atta"!=t.comment||(m=JSON.parse('{"AttachParam": "atta"}').AttachParam);return!m&&t&&t.comment&&t.comment.Param&&(m=t.comment.Param),l.__controls.initWithContent(f,m).catch(function(t){i.emit("error:"+t.name,t)}),{senderId:r,receiverId:e,withPeer:o||"group"===n?e:r,isFromMe:o,chatType:n,time:h,serial:t.serial,serverId:t.svr_msgid,message:l}},o.Y=function(t,n,i){var r,e;switch(n){case"user":default:r=1;break;case"group":r=2}if(e=0===i.getTypeId()&&"text"!==i.getType()?i.getType()+"!"+i.getContent():i.getContent(),"text"===i.getType())return{msgbodytype:i.getTypeId(),chattype:r,receiver:t,content:e,comment:{AttachParam:i.getExtraParam()}};if("voice"===i.getType()){var o=JSON.parse(e);return{msgbodytype:i.getTypeId(),chattype:r,receiver:t,content:e,comment:{h5:"true",Param:o.extra+"",FileSize:o.datasize+"",Time:parseInt(o.voicetime)+""}}}if("file"===i.getType()){var s=JSON.parse(e),u=s.downloadurl;return/^https:/i.test(u)||(u="https:"+u),{msgbodytype:i.getTypeId(),chattype:r,receiver:t,content:u+"",comment:{h5:"true",Param:s.extra+"",FileSize:s.filesize+"",FileType:s.filetype+"",FileName:s.filename+"",Extension:s.extension}}}return{msgbodytype:i.getTypeId(),chattype:r,receiver:t,content:e,comment:{AttachParam:i.getExtraParam()}}},o.prototype.$=function(t,n,i,r){return{senderId:this.i.get("userId"),receiverId:t,withPeer:t,isFromMe:!0,chatType:n,time:new Date,serverId:i,message:r}},o.prototype.nt=function(t){if(this.F.has(t.serverId))return!1;var n=t.withPeer;switch(t.chatType){case"group":for(this.M[n]=this.M[n]||[],this.M[n].push(t),this.F.add(t.serverId);30<this.M[n].length;){(i=this.M[n].shift())&&this.F.delete(i.serverId)}break;case"user":for(this.H[n]=this.H[n]||[],this.H[n].push(t),this.F.add(t.serverId);30<this.H[n].length;){var i;(i=this.H[n].shift())&&this.F.delete(i.serverId)}}return!0},o.prototype.Z=function(t){return this.r.send(5,t).catch(function(t){})},o.prototype.V=function(t){var e=this;return t.__controls.onRequestUploadToken(function(t,n,i,r){return e.G(t,n,i,r)}),t.__controls.onRequestWechatToken(function(){return e.Q()}),t.__controls.waitForContent().then(function(){return t}).catch(function(t){throw"CanceledError"===t.name&&e.emit("error:"+t.name,t),t})},o.prototype.G=function(t,n,i,r){return this.r.send(8,{filename:i,filesize:t,filemd5:n,filesuffix:r}).then(function(t){return{headers:t.headers,uploadUrl:t.token,downloadUrl:t.downloadurl}}).catch(function(){return{headers:{},uploadUrl:"",downloadUrl:""}})},o.prototype.Q=function(){var n=this,t=+new Date-+this.z;return this.K&&t<3e5?Promise.resolve(this.K):this.r.send(12,{}).then(function(t){return n.K=t.token,n.z=new Date,n.K}).catch(function(){return n.K})},o}(n),S=function(e){function t(t,n,i){var r=e.call(this)||this;return r.rt="",r.et={},r.ot="",r.st=-1,r.typeId=2,r.typeName="file",0<=t&&(r.st=t),void 0!==n&&r.setFileName(n),void 0!==i&&r.setExtra(i),r}return s(t,e),t.prototype.setExtra=function(t){void 0!==t&&(this.rt=t.toString())},t.prototype.getExtra=function(){return this.rt},t.prototype.setFileType=function(t){0<=t&&(this.st=t)},t.prototype.getFileType=function(){return this.st},t.prototype.setFileName=function(t){void 0!==t&&(this.ot=t.toString())},t.prototype.getFileName=function(){return this.ot},t.prototype.initWithContent=function(n){var i;try{i=JSON.parse(n)}catch(t){i=n}return"object"==typeof i&&this.setExtra(i.extra),this.setContent(n),Promise.resolve()},t.prototype.uploadSingleFile=function(i){var r=this;return this.uploadFile(i).then(function(t){r.et={filesize:i.size,filetype:r.getFileType(),filename:r.getFileName(),extension:i.type.split("/")[1],downloadurl:t};var n=Object.assign({},r.et,{extra:r.rt});r.setContent(n)})},t}(g);window?(window.TextMessage=k,window.FileMessage=S):(global.TextMessage=k,global.FileMessage=S),"undefined"!=typeof window&&("undefined"!=typeof wx&&null!=wx||(window.wx=!1),"undefined"!=typeof tt&&null!=tt||(window.tt=!1),"undefined"!=typeof qg&&null!=qg||(window.qg=!1),"undefined"!=typeof uni&&null!=uni||(window.uni=!1),"undefined"!=typeof ks&&null!=ks||(window.ks=!1),"undefined"!=typeof qg&&null!=qg||(window.qg=!1));var I=function(i){function r(t){var n=i.call(this)||this;return n.s="",n.i=new e,n.r=new m(n.i),n.ut=new o(n.i,n.r),n.ht=new u(n.i,n.r),n.ct=new A(n.i,n.r),n.ft(),n.at(),n.dt(),n.vt(),n.lt(),t&&n.init(t).then(),console.log("ver:",r.VERSION),n}return s(r,i),r.prototype.init=function(t){var n=[];if(this.s=t.appKey,t.userId&&t.token&&n.push(this.login(t.userId+"",t.token,t.timestamp,!0).then(function(){})),t.roomId){t.roomId instanceof Array||(t.roomId=[t.roomId]);for(var i=0,r=t.roomId;i<r.length;i++){var e=r[i];n.push(this.joinRoom(e).then(function(){}))}}return t.useMessageType&&this.registerMessageType(t.useMessageType),t.userId&&t.token?Promise.all(n).then(function(){}):Promise.resolve()},r.prototype.uninit=function(){this.logout()},r.prototype.login=function(t,n,i,r){return void 0===i&&(i=""),void 0===r&&(r=!1),this.ut.login(this.s,""+t,n,i).catch(function(t){if(!r)throw t})},r.prototype.logout=function(){this.ht.clear(),this.ct.clear(),this.ut.logout()},r.prototype.isLogging=function(){return this.ut.isLogging()},r.prototype.isLogged=function(){return this.ut.isLogged()},r.prototype.getMyUserId=function(){return this.ut.getMyUserId()},r.prototype.getHistoryContact=function(t){return this.ct.getHistoryContact(t,this.getMyUserId())},r.prototype.deleteHistoryContact=function(t,n){return this.ct.deleteHistoryContact(t,this.getMyUserId(),n)},r.prototype.joinRoom=function(t){var n=this;return this.ut.doIfLogged().then(function(){return n.ht.joinRoom(t)})},r.prototype.leaveRoom=function(t){var n=this;return this.ut.doIfLogged().then(function(){return t?n.ht.leaveRoom(t):n.ht.leaveAllRoom()})},r.prototype.inRoom=function(t){return this.ht.inRoom(t)},r.prototype.getRoomIdList=function(){return this.ht.getRoomIdList()},r.prototype.registerMessageType=function(t){if(t instanceof Array)for(var n=0,i=t;n<i.length;n++){var r=i[n];this.ct.registerMessageType(r)}else this.ct.registerMessageType(t)},r.prototype.sendToRoom=function(t,n,i){var r=this;return void 0===i&&(i=!1),this.ut.doIfLogged().then(function(){return r.ht.doIfJoinedRoom(t+"")}).then(function(){return r.ct.sendToRoom(t+"",n)}).catch(function(t){if(!i&&(i=!0,!n.isCanceled()))throw t})},r.prototype.sendToUser=function(t,n,i){var r=this;return void 0===i&&(i=!1),this.ut.doIfLogged().then(function(){return r.ct.sendToUser(t+"",n,r.getMyUserId())}).catch(function(t){if(!i&&(i=!0,!n.isCanceled()))throw t})},r.prototype.requestHistoryMessage=function(t,n,i,r){return this.ct.requestHistoryMessage(t,n,i,r)},r.prototype.queryRoomHistoryMessageByLastMsgid=function(t,n,i,r){return this.ct.queryRoomHistoryMessageByLastMsgid(t,n,i,r)},r.prototype.queryPrivateHistoryMessageByLastMsgid=function(t,n,i,r,e){return this.ct.queryPrivateHistoryMessageByLastMsgid(t,this.getMyUserId(),n,i,r,e)},r.prototype.ft=function(){var t=this;this.r.on("status:reconnecting",function(){return t.ut.reconnect().then(function(){return t.ht.reconnect()})})},r.prototype.at=function(){var i=this;this.ut.on("login",function(){return i.emit("account.login")}),this.ut.on("logging",function(){return i.emit("account.logging")}),this.ut.on("logout",function(){return i.emit("account.logout")}),this.ut.on("kickoff",function(){return i.emit("account.kickoff")}),this.ut.on("error:*",function(t,n){return i.emit("account."+t,n)})},r.prototype.dt=function(){var r=this;this.ht.on("join:*",function(t,n){return r.emit("room.join:"+n,n)}),this.ht.on("joining:*",function(t,n){return r.emit("room.joining:"+n,n)}),this.ht.on("leave:*",function(t,n){return r.emit("room.leave:"+n,n)}),this.ht.on("join-error:*",function(t,n,i){return r.emit("room.join-error:"+n.name,n,i)}),this.ht.on("leave-error:*",function(t,n,i){return r.emit("room.leave-error:"+n.name,n,i)})},r.prototype.vt=function(){var r=this;this.ct.on("send:*",function(t,n){return r.emit("message:send:"+n.chatType+":"+n.withPeer,n)}),this.ct.on("send-failed:*",function(t,n,i){return r.emit("message:"+t,n,i)}),this.ct.on("receive:*",function(t,n){return r.emit("message:receive:"+n.chatType+":"+n.withPeer,n)})},r.prototype.lt=function(){var i=this;this.r.on("status:*",function(t,n){return i.emit("signaling.status:"+n,n)}),this.r.on("ready",function(){return i.emit("signaling.ready")}),this.r.on("message:*",function(t,n){return i.emit("signaling.receive:"+n.base.msgtype,n)}),this.r.on("send:*",function(t,n){return i.emit("signaling.send:"+n.base.msgtype,n)}),this.r.on("error",function(t){return i.emit("signaling.error",t)})},r.VERSION="2.2.1",r.Message=g,r.WildEmitter=n,r}(n);t.TextMessage=k,t.FileMessage=S,t.default=I,Object.defineProperty(t,"__esModule",{value:!0})});
